<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BudgetBloom — Personal Budget Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #f1f5f9;
      --bg-card: #ffffff;
      --bg-sidebar: #0f172a;
      --text: #1e293b;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --accent-light: #eef2ff;
      --mint: #10b981;
      --mint-light: #ecfdf5;
      --lavender: #8b5cf6;
      --lavender-light: #f5f3ff;
      --peach: #f59e0b;
      --peach-light: #fffbeb;
      --sky: #0ea5e9;
      --sky-light: #f0f9ff;
      --coral: #ef4444;
      --coral-light: #fef2f2;
      --yellow: #eab308;
      --yellow-light: #fefce8;
      --shadow-sm: 0 1px 3px rgba(15,23,42,0.04);
      --shadow-md: 0 4px 12px rgba(15,23,42,0.06);
      --shadow-lg: 0 8px 30px rgba(15,23,42,0.08);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-xs: 6px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    h1, h2, h3, h4 { font-family: 'Inter', sans-serif; }

    /* ── LAYOUT ── */
    .app { display: flex; min-height: 100vh; }

    .sidebar {
      width: 260px;
      background: var(--bg-sidebar);
      border-right: none;
      padding: 28px 20px;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 100;
      color: #cbd5e1;
    }

    .main { flex: 1; margin-left: 260px; padding: 28px 32px; }

    .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 36px; }
    .logo-icon { font-size: 16px; font-weight: 800; color: white; font-family: 'Inter'; width: 36px; height: 36px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .logo h1 { font-size: 18px; font-weight: 800; color: #f1f5f9; letter-spacing: -0.02em; }
    .logo span { color: var(--accent); color: #a5b4fc; }

    .nav-section { margin-bottom: 24px; }
    .nav-section-title {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.12em; color: #475569; margin-bottom: 10px; padding-left: 12px;
    }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px;
      border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s;
      font-size: 14px; font-weight: 500; color: #94a3b8;
    }
    .nav-item:hover { background: rgba(99,102,241,0.1); color: #e2e8f0; }
    .nav-item.active { background: rgba(99,102,241,0.15); color: #a5b4fc; font-weight: 600; }
    .nav-item .icon { font-size: 16px; width: 24px; text-align: center; }

    /* ── HEADER ── */
    .page-header { margin-bottom: 28px; }
    .page-header h2 { font-size: 26px; font-weight: 800; margin-bottom: 4px; }
    .page-header p { color: var(--text-muted); font-size: 14px; }

    /* ── STAT CARDS ── */
    .stats-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px;
    }
    .stat-card {
      background: var(--bg-card); border-radius: var(--radius); padding: 20px;
      box-shadow: var(--shadow-sm); border: 1px solid rgba(15,23,42,0.04);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .stat-card .label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
    .stat-card .value { font-family: 'Inter', sans-serif; font-size: 28px; font-weight: 800; }
    .stat-card .sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .stat-card.pink { border-left: 4px solid var(--accent); }
    .stat-card.pink .value { color: var(--accent); }
    .stat-card.mint { border-left: 4px solid var(--mint); }
    .stat-card.mint .value { color: #059669; }
    .stat-card.lavender { border-left: 4px solid var(--lavender); }
    .stat-card.lavender .value { color: #7c3aed; }
    .stat-card.peach { border-left: 4px solid var(--sky); }
    .stat-card.peach .value { color: #0284c7; }

    /* ── CARDS ── */
    .card {
      background: var(--bg-card); border-radius: var(--radius); padding: 24px;
      box-shadow: var(--shadow-sm); border: 1px solid rgba(15,23,42,0.04); margin-bottom: 20px;
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .card-title { font-size: 16px; font-weight: 700; }
    .card-badge {
      font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600;
    }

    /* ── GRID LAYOUTS ── */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

    /* ── TABLE ── */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead th {
      background: var(--bg); padding: 10px 14px; text-align: left;
      font-weight: 600; font-size: 11px; text-transform: uppercase;
      letter-spacing: 0.06em; color: var(--text-muted); border-bottom: 2px solid rgba(15,23,42,0.06);
    }
    tbody td {
      padding: 12px 14px; border-bottom: 1px solid rgba(15,23,42,0.04);
      vertical-align: middle;
    }
    tbody tr { transition: background 0.15s; }
    tbody tr:hover { background: #f8fafc; }
    .amount { font-family: 'Inter', sans-serif; font-weight: 700; }
    .amount.negative { color: #d06060; }

    .category-pill {
      display: inline-block; padding: 3px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 600;
    }

    .review-flag {
      display: inline-flex; align-items: center; gap: 4px;
      background: var(--yellow-light); color: #92400e; padding: 3px 8px;
      border-radius: 12px; font-size: 11px; font-weight: 600;
    }

    /* ── CATEGORY BARS ── */
    .category-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(15,23,42,0.04); }
    .category-row:last-child { border-bottom: none; }
    .category-name { width: 200px; font-size: 13px; font-weight: 600; flex-shrink: 0; }
    .category-bar-wrap { flex: 1; height: 10px; background: var(--bg); border-radius: 10px; overflow: hidden; }
    .category-bar { height: 100%; border-radius: 10px; transition: width 0.6s ease; }
    .category-amount { width: 100px; text-align: right; font-family: 'Inter'; font-weight: 700; font-size: 13px; flex-shrink: 0; }
    .category-avg { width: 90px; text-align: right; font-size: 12px; color: var(--text-muted); flex-shrink: 0; }

    /* ── CREDIT CARD CARDS ── */
    .cc-card {
      padding: 18px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 14px;
      margin-bottom: 10px; transition: transform 0.15s;
    }
    .cc-card:hover { transform: translateX(4px); }
    .cc-icon { font-size: 28px; width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .cc-info { flex: 1; }
    .cc-name { font-weight: 700; font-size: 14px; }
    .cc-amount { font-family: 'Inter'; font-weight: 800; font-size: 18px; }
    .cc-pct { font-size: 12px; color: var(--text-muted); }

    /* ── FORM / MODAL ── */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(15,23,42,0.4);
      backdrop-filter: blur(4px); z-index: 200; align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bg-card); border-radius: var(--radius); padding: 32px;
      width: 560px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg);
    }
    .modal h3 { font-size: 20px; font-weight: 800; margin-bottom: 20px; }

    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block; font-size: 12px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 6px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 10px 14px; border: 1.5px solid rgba(15,23,42,0.1);
      border-radius: var(--radius-sm); font-family: 'DM Sans'; font-size: 14px;
      background: var(--bg); color: var(--text); transition: border-color 0.2s;
      outline: none;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: var(--accent);
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .btn {
      display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px;
      border-radius: var(--radius-sm); border: none; cursor: pointer;
      font-family: 'Inter'; font-weight: 700; font-size: 14px; transition: all 0.2s;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
    .btn-secondary { background: var(--bg); color: var(--text-muted); }
    .btn-secondary:hover { background: rgba(15,23,42,0.06); }
    .btn-sm { padding: 6px 14px; font-size: 12px; }

    .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

    .checkbox-row { display: flex; align-items: center; gap: 8px; }
    .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); }

    /* ── THERAPY HIGHLIGHT ── */
    .therapy-card {
      background: linear-gradient(135deg, var(--lavender-light), var(--sky-light));
      border-radius: var(--radius); padding: 24px; margin-bottom: 20px;
    }
    .therapy-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
    .therapy-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    .therapy-item { text-align: center; }
    .therapy-item .t-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .therapy-item .t-value { font-family: 'Inter'; font-size: 24px; font-weight: 800; color: #7c3aed; }
    .therapy-item .t-avg { font-size: 12px; color: var(--text-muted); }

    /* ── TABS ── */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--bg); padding: 4px; border-radius: var(--radius-sm); width: fit-content; }
    .tab {
      padding: 8px 16px; border-radius: var(--radius-xs); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; color: var(--text-muted);
    }
    .tab.active { background: var(--bg-card); color: var(--text); box-shadow: var(--shadow-sm); }
    .tab:hover:not(.active) { color: var(--text); }

    /* ── SECTIONS (pages) ── */
    .page { display: none; }
    .page.active { display: block; }

    /* ── MOBILE MENU TOGGLE ── */
    .mobile-header {
      display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 150;
      background: var(--bg-sidebar); padding: 12px 16px;
      align-items: center; justify-content: space-between;
    }
    .mobile-header .logo { margin-bottom: 0; }
    .hamburger {
      width: 36px; height: 36px; border-radius: 8px; border: none;
      background: rgba(99,102,241,0.15); color: #a5b4fc; font-size: 20px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .sidebar-overlay {
      display: none; position: fixed; inset: 0; background: rgba(15,23,42,0.5);
      z-index: 99;
    }
    .sidebar-overlay.active { display: block; }

    /* ── RESPONSIVE ── */
    @media (max-width: 1024px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .mobile-header { display: flex; }

      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 200;
        padding-top: 16px;
      }
      .sidebar.open { transform: translateX(0); }

      .main { margin-left: 0; padding: 60px 16px 24px; }

      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .stat-card { padding: 14px; }
      .stat-card .value { font-size: 22px; }

      .therapy-grid { grid-template-columns: 1fr; }

      .page-header { flex-direction: column !important; gap: 12px; align-items: flex-start !important; }
      .page-header h2 { font-size: 22px; }

      .card { padding: 16px; margin-bottom: 14px; }
      .card-header { flex-direction: column; gap: 10px; align-items: flex-start; }

      .modal { width: 95vw; max-width: 95vw; padding: 20px; margin: 10px; }
      .form-row { grid-template-columns: 1fr; }

      .table-wrap { margin: 0 -16px; padding: 0 16px; }
      table { font-size: 12px; }
      thead th { padding: 8px 10px; font-size: 10px; }
      tbody td { padding: 10px; }

      .category-name { width: 130px; font-size: 12px; }
      .category-amount { width: 80px; font-size: 12px; }
      .category-avg { display: none; }
      .cat-sub-actions { gap: 0; }
      .cat-header-actions { flex-direction: column; gap: 6px; }

      .cc-card { flex-wrap: wrap; gap: 10px; }
      .cc-amount { font-size: 16px; }

      .btn { padding: 8px 14px; font-size: 13px; }
      .btn-sm { padding: 6px 10px; font-size: 11px; }
      .btn-approve, .btn-decline { padding: 3px 8px; font-size: 10px; }
      .review-flag { font-size: 10px; padding: 2px 6px; }

      .txn-actions { gap: 2px; }
      .btn-icon { width: 26px; height: 26px; font-size: 12px; }

      .group-header-bar { flex-direction: column; align-items: flex-start !important; gap: 6px; }
    }

    @media (max-width: 480px) {
      .stats-grid { grid-template-columns: 1fr; }
      .stat-card .value { font-size: 20px; }
      .page-header h2 { font-size: 20px; }

      .category-row { flex-wrap: wrap; gap: 6px; }
      .category-name { width: 100%; }
      .category-bar-wrap { order: 3; width: 100%; }
    }

    /* ── SYNC INDICATOR ── */
    .sync-dot {
      width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px;
    }
    .sync-dot.connected { background: #10b981; }
    .sync-dot.disconnected { background: #64748b; }
    .sync-dot.syncing { background: #eab308; animation: pulse 1s infinite; }
    .sync-dot.error { background: #ef4444; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .sync-bar {
      display: flex; align-items: center; gap: 6px; padding: 8px 12px;
      font-size: 11px; color: #94a3b8; margin-top: 8px;
    }
    .settings-section { margin-bottom: 24px; }
    .settings-section h4 { font-size: 14px; font-weight: 700; margin-bottom: 12px; }
    .settings-divider { border: none; border-top: 1px solid rgba(15,23,42,0.06); margin: 20px 0; }

    /* ── ANIMATIONS ── */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-in { animation: fadeIn 0.4s ease forwards; }

    /* ── MANAGEMENT BUTTONS ── */
    .btn-icon {
      width: 28px; height: 28px; border-radius: 8px; border: none;
      background: transparent; cursor: pointer; font-size: 13px;
      display: inline-flex; align-items: center; justify-content: center;
      transition: all 0.2s; color: var(--text-light);
    }
    .btn-icon:hover { background: var(--accent-light); color: var(--accent-hover); }
    .btn-icon.danger:hover { background: var(--coral-light); color: #d06060; }
    .btn-approve {
      display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px;
      border-radius: 8px; border: 1.5px solid var(--mint); background: var(--mint-light);
      color: #5bb88a; font-size: 11px; font-weight: 700; cursor: pointer;
      font-family: 'Inter'; transition: all 0.2s;
    }
    .btn-approve:hover { background: var(--mint); color: white; }
    .btn-decline {
      display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px;
      border-radius: 8px; border: 1.5px solid var(--coral); background: var(--coral-light);
      color: #dc2626; font-size: 11px; font-weight: 700; cursor: pointer;
      font-family: 'Inter'; transition: all 0.2s;
    }
    .btn-decline:hover { background: var(--coral); color: white; }
    .status-declined {
      display: inline-flex; align-items: center; gap: 4px;
      color: #dc2626; font-size: 12px; font-weight: 600;
    }
    .txn-actions { display: flex; gap: 4px; align-items: center; }
    .cat-header-actions { display: flex; gap: 8px; align-items: center; }
    .cat-sub-actions { display: flex; gap: 2px; flex-shrink: 0; margin-left: auto; }
    .group-header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; }
    .group-actions { display: flex; gap: 2px; align-items: center; }
    .approve-info { background: var(--yellow-light); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 13px; }
    .approve-info strong { color: var(--text); }
    .period-btn {
      padding: 4px 10px; border-radius: 6px; border: 1.5px solid rgba(148,163,184,0.2);
      background: rgba(30,41,59,0.5); color: #94a3b8; font-family: 'Inter'; font-size: 11px;
      font-weight: 700; cursor: pointer; transition: all 0.2s;
    }
    .period-btn:hover { border-color: #6366f1; color: #a5b4fc; }
    .period-btn.active { background: #6366f1; color: white; border-color: #6366f1; }

    /* ── SCROLLBAR ── */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(15,23,42,0.15); border-radius: 10px; }
  </style>
</head>
<body>
  <div class="app">
    <!-- MOBILE HEADER -->
    <div class="mobile-header">
      <div class="logo">
        <span class="logo-icon">B</span>
        <h1>Budget<span>Bloom</span></h1>
      </div>
      <button class="hamburger" onclick="toggleSidebar()" id="hamburger-btn">☰</button>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="logo">
        <span class="logo-icon">B</span>
        <h1>Budget<span>Bloom</span></h1>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <div class="nav-item active" data-page="dashboard">
          <span class="icon">◉</span> Dashboard
        </div>
        <div class="nav-item" data-page="transactions">
          <span class="icon">⊞</span> Transactions
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Breakdown</div>
        <div class="nav-item" data-page="categories">
          <span class="icon">⊟</span> Categories
        </div>
        <div class="nav-item" data-page="cards">
          <span class="icon">▣</span> Credit Cards
        </div>
        <div class="nav-item" data-page="therapy">
          <span class="icon">◈</span> Therapy
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">System</div>
        <div class="nav-item" data-page="settings">
          <span class="icon">⚙</span> Settings
        </div>
        <div class="sync-bar" id="sync-bar">
          <span class="sync-dot disconnected" id="sync-dot"></span>
          <span id="sync-label">Local Storage</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Period</div>
        <div style="padding: 4px 12px;">
          <div id="period-presets" style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px;">
            <button class="period-btn" data-months="3">3M</button>
            <button class="period-btn" data-months="6">6M</button>
            <button class="period-btn active" data-months="12">12M</button>
            <button class="period-btn" data-months="ytd">YTD</button>
            <button class="period-btn" data-months="all">All</button>
            <button class="period-btn" data-months="custom">Custom</button>
          </div>
          <div id="custom-range" style="display:none; margin-bottom:8px;">
            <label style="font-size:10px; font-weight:600; color:#64748b; text-transform:uppercase; letter-spacing:0.06em;">From</label>
            <input type="month" id="range-from" style="width:100%; padding:6px 8px; border:1.5px solid rgba(148,163,184,0.2); border-radius:6px; font-family:'DM Sans'; font-size:12px; background:rgba(30,41,59,0.5); color:#cbd5e1; margin-bottom:6px;" />
            <label style="font-size:10px; font-weight:600; color:#64748b; text-transform:uppercase; letter-spacing:0.06em;">To</label>
            <input type="month" id="range-to" style="width:100%; padding:6px 8px; border:1.5px solid rgba(148,163,184,0.2); border-radius:6px; font-family:'DM Sans'; font-size:12px; background:rgba(30,41,59,0.5); color:#cbd5e1;" />
          </div>
          <div id="period-label" style="font-size:11px; color:#64748b; line-height:1.5;">
            <strong id="period-range-text" style="color:#cbd5e1; font-size:12px;">—</strong><br>
            <span id="period-month-count">—</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main">

      <!-- ════ DASHBOARD PAGE ════ -->
      <div class="page active" id="page-dashboard">
        <div class="page-header">
          <h2>Dashboard</h2>
          <p>Your spending overview at a glance</p>
        </div>

        <div class="stats-grid" id="stats-grid"></div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <span class="card-title">Monthly Spending</span>
            </div>
            <canvas id="monthlyChart" height="200"></canvas>
          </div>
          <div class="card">
            <div class="card-header">
              <span class="card-title">Category Breakdown</span>
            </div>
            <canvas id="categoryPieChart" height="200"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Recent Transactions</span>
            <button class="btn btn-primary btn-sm" onclick="openModal()">+ Add Transaction</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Card</th>
                  <th>Vendor</th>
                  <th>Amount</th>
                  <th>Category</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="recent-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ════ TRANSACTIONS PAGE ════ -->
      <div class="page" id="page-transactions">
        <div class="page-header" style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <h2>Transactions</h2>
            <p>All credit card & account charges</p>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
            <button class="btn btn-primary" onclick="openModal()">+ Add Transaction</button>
          </div>
        </div>

        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <select id="filter-card" onchange="renderTransactions()" style="padding:8px 12px; border:1.5px solid rgba(15,23,42,0.1); border-radius:8px; font-family:'DM Sans'; font-size:13px; background:var(--bg); color:var(--text);">
              <option value="">All Cards</option>
            </select>
            <select id="filter-category" onchange="renderTransactions()" style="padding:8px 12px; border:1.5px solid rgba(15,23,42,0.1); border-radius:8px; font-family:'DM Sans'; font-size:13px; background:var(--bg); color:var(--text);">
              <option value="">All Categories</option>
            </select>
            <select id="filter-month" onchange="renderTransactions()" style="padding:8px 12px; border:1.5px solid rgba(15,23,42,0.1); border-radius:8px; font-family:'DM Sans'; font-size:13px; background:var(--bg); color:var(--text);">
              <option value="">All Months</option>
            </select>
            <select id="filter-review" onchange="renderTransactions()" style="padding:8px 12px; border:1.5px solid rgba(15,23,42,0.1); border-radius:8px; font-family:'DM Sans'; font-size:13px; background:var(--bg); color:var(--text);">
              <option value="">All Status</option>
              <option value="yes">Needs Review</option>
              <option value="no">Approved</option>
              <option value="declined">Declined</option>
            </select>
          </div>
        </div>

        <div class="card">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Card / Account</th>
                  <th>Vendor / Merchant</th>
                  <th>Amount</th>
                  <th>Category</th>
                  <th>Notes</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="txn-table"></tbody>
            </table>
          </div>
          <div id="txn-empty" style="display:none; text-align:center; padding:48px; color:var(--text-muted);">
            <div style="font-size:36px; margin-bottom:12px; opacity:0.4;">⊞</div>
            <p style="font-size:14px;">No transactions yet. Click <strong>+ Add Transaction</strong> to get started!</p>
          </div>
        </div>
      </div>

      <!-- ════ CATEGORIES PAGE ════ -->
      <div class="page" id="page-categories">
        <div class="page-header" style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <h2>Categories</h2>
            <p>Manage and track spending per category</p>
          </div>
          <div class="cat-header-actions">
            <button class="btn btn-secondary btn-sm" onclick="openGroupModal()">+ New Group</button>
            <button class="btn btn-primary btn-sm" onclick="openCatModal()">+ Add Category</button>
          </div>
        </div>
        <div class="card" id="categories-breakdown"></div>
      </div>

      <!-- ════ CREDIT CARDS PAGE ════ -->
      <div class="page" id="page-cards">
        <div class="page-header">
          <h2>Credit Cards</h2>
          <p>Spending breakdown by card</p>
        </div>
        <div class="grid-2">
          <div class="card" id="cards-list"></div>
          <div class="card">
            <div class="card-header"><span class="card-title">Card Distribution</span></div>
            <canvas id="cardsPieChart" height="260"></canvas>
          </div>
        </div>
      </div>

      <!-- ════ THERAPY PAGE ════ -->
      <div class="page" id="page-therapy">
        <div class="page-header">
          <h2>Therapy Expenses</h2>
          <p>Combined therapy tracking for Kids & Health</p>
        </div>
        <div class="therapy-card" id="therapy-summary"></div>
        <div class="card">
          <div class="card-header"><span class="card-title">Therapy Transactions</span></div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Date</th><th>Card</th><th>Provider</th><th>Amount</th><th>Type</th></tr></thead>
              <tbody id="therapy-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ════ SETTINGS PAGE ════ -->
      <div class="page" id="page-settings">
        <div class="page-header">
          <h2>Settings</h2>
          <p>Connect to Google Sheets for cloud storage</p>
        </div>

        <div class="card">
          <div class="settings-section">
            <div class="card-header">
              <span class="card-title">Google Sheets Connection</span>
              <span class="category-pill" id="settings-status" style="background:var(--bg);color:var(--text-muted);">Disconnected</span>
            </div>
            <div class="form-group">
              <label>Apps Script Web App URL</label>
              <input type="text" id="api-url" placeholder="https://script.google.com/macros/s/.../exec" />
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" onclick="connectAPI()">Connect</button>
              <button class="btn btn-secondary" onclick="disconnectAPI()">Disconnect</button>
            </div>
          </div>

          <hr class="settings-divider" />

          <div class="settings-section">
            <h4>Data Sync</h4>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
              <button class="btn btn-primary btn-sm" onclick="pushToSheet()" id="btn-push">Push Local → Sheet</button>
              <button class="btn btn-secondary btn-sm" onclick="pullFromSheet()" id="btn-pull">Pull Sheet → Local</button>
            </div>
            <p style="font-size:12px; color:var(--text-muted); line-height:1.6;">
              <strong>Push</strong> uploads all local data to Google Sheets (overwrites sheet).<br>
              <strong>Pull</strong> downloads from Google Sheets (overwrites local data).<br>
              After connecting, changes sync automatically to the sheet.
            </p>
          </div>

          <hr class="settings-divider" />

          <div class="settings-section">
            <h4>Local Storage</h4>
            <p style="font-size:12px; color:var(--text-muted); margin-bottom:12px;">
              Transactions: <strong id="local-txn-count">0</strong> |
              Categories: <strong id="local-cat-count">0</strong> groups
            </p>
            <button class="btn btn-secondary btn-sm" onclick="clearLocalData()" style="color:#dc2626;">Clear Local Data</button>
          </div>
        </div>

        <div class="card" style="background:var(--sky-light); border:1px solid #bae6fd;">
          <h4 style="margin-bottom:8px;">Setup Instructions</h4>
          <ol style="font-size:13px; color:var(--text-muted); line-height:2; padding-left:18px;">
            <li>Create a new Google Sheet</li>
            <li>Go to <strong>Extensions → Apps Script</strong></li>
            <li>Paste the contents of <code>Code.gs</code></li>
            <li>Run <strong>initialSetup</strong> (authorize when prompted)</li>
            <li>Click <strong>Deploy → New deployment → Web app</strong></li>
            <li>Set access to <strong>Anyone</strong>, click Deploy</li>
            <li>Copy the URL and paste it above</li>
          </ol>
        </div>
      </div>

    </main>
  </div>

  <!-- ════ ADD/EDIT TRANSACTION MODAL ════ -->
  <div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <h3 id="txn-modal-title">Add Transaction</h3>
      <form id="txn-form" onsubmit="return saveTransaction(event)">
        <input type="hidden" id="f-edit-id" value="" />
        <div class="form-row">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="f-date" required />
          </div>
          <div class="form-group">
            <label>Credit Card / Account</label>
            <select id="f-card" required></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Vendor / Merchant</label>
            <input type="text" id="f-vendor" placeholder="e.g. SAFEWAY, UBER" required />
          </div>
          <div class="form-group">
            <label>Amount ($)</label>
            <input type="number" id="f-amount" step="0.01" min="0" placeholder="0.00" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Category</label>
            <select id="f-category" required></select>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <input type="text" id="f-notes" placeholder="Optional notes..." />
          </div>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="f-status">
            <option value="approved">Approved</option>
            <option value="review">Needs Review</option>
            <option value="declined">Declined</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="txn-submit-btn">Add Transaction</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ════ CATEGORY MANAGEMENT MODAL ════ -->
  <div class="modal-overlay" id="cat-modal-overlay" onclick="if(event.target===this)closeCatModal()">
    <div class="modal" style="width:440px;">
      <h3 id="cat-modal-title">Add Category</h3>
      <form id="cat-form" onsubmit="return saveCategoryForm(event)">
        <div class="form-group">
          <label>Group</label>
          <select id="cf-group" required></select>
        </div>
        <div class="form-group">
          <label>Category Name</label>
          <input type="text" id="cf-name" placeholder="e.g. Subscriptions" required />
        </div>
        <input type="hidden" id="cf-mode" value="add" />
        <input type="hidden" id="cf-old-name" value="" />
        <input type="hidden" id="cf-old-group" value="" />
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeCatModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Category</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ════ NEW GROUP MODAL ════ -->
  <div class="modal-overlay" id="group-modal-overlay" onclick="if(event.target===this)closeGroupModal()">
    <div class="modal" style="width:400px;">
      <h3>New Category Group</h3>
      <form id="group-form" onsubmit="return saveGroupForm(event)">
        <div class="form-group">
          <label>Group Name</label>
          <input type="text" id="gf-name" placeholder="e.g. Subscriptions & Services" required />
        </div>
        <div class="form-group">
          <label>Color</label>
          <select id="gf-color">
            <option value="#a8d4e6">Sky Blue</option>
            <option value="#e8a0bf">Pink</option>
            <option value="#b8e6d0">Mint</option>
            <option value="#c7b8ea">Lavender</option>
            <option value="#f5c6a5">Peach</option>
            <option value="#f0df8a">Yellow</option>
            <option value="#f0a8a8">Coral</option>
            <option value="#dbc4f0">Purple</option>
            <option value="#d1d5db">Gray</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeGroupModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Group</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ════ REVIEW APPROVAL MODAL ════ -->
  <div class="modal-overlay" id="approve-modal-overlay" onclick="if(event.target===this)closeApproveModal()">
    <div class="modal" style="width:460px;">
      <h3>✓ Approve Transaction</h3>
      <div class="approve-info" id="approve-info"></div>
      <div class="form-group">
        <label>Category (change if needed)</label>
        <select id="approve-category"></select>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <input type="text" id="approve-notes" placeholder="Optional notes..." />
      </div>
      <input type="hidden" id="approve-txn-id" value="" />
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeApproveModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmApproval()" style="background:var(--mint);color:white;">Approve ✓</button>
      </div>
    </div>
  </div>

  <script>
    // ── API WRAPPER ──
    const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbxMMUsKVTPzl8x_3QxwEMQFW4974f9U8yFbwboAKMOWk35DV0eFh4xS-hU1r45nKtlHMA/exec';
    const API = {
      get url() {
        const stored = localStorage.getItem('bb_api_url');
        if (stored === null) return DEFAULT_API_URL;
        return stored;
      },
      set url(v) { localStorage.setItem('bb_api_url', v); },
      get isConnected() { return !!this.url; },

      async post(payload) {
        if (!this.url) return null;
        try {
          const res = await fetch(this.url, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload),
            redirect: 'follow',
          });
          return await res.json();
        } catch (err) {
          console.error('API error:', err);
          return null;
        }
      },

      async get(action) {
        if (!this.url) return null;
        try {
          const res = await fetch(this.url + '?action=' + action, { redirect: 'follow' });
          return await res.json();
        } catch (err) {
          console.error('API error:', err);
          return null;
        }
      }
    };

    // ── DATA ──
    const CREDIT_CARDS = ['Apple', 'Capital One Silver', 'Capital One Blue', 'Concora', 'Brightway', 'Wells Fargo'];
    const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    // ── DATE RANGE STATE ──
    let activePreset = '12';
    let MONTHS = [];
    let rangeMonthCount = 0;

    function generateMonthRange(fromDate, toDate) {
      const months = [];
      const d = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);
      const end = new Date(toDate.getFullYear(), toDate.getMonth(), 1);
      while (d <= end) {
        months.push(MONTH_NAMES[d.getMonth()] + ' ' + d.getFullYear());
        d.setMonth(d.getMonth() + 1);
      }
      return months;
    }

    function getDataDateRange() {
      const now = new Date();
      const currentMonth = new Date(now.getFullYear(), now.getMonth(), 1);

      if (transactions.length === 0) {
        return { earliest: currentMonth, latest: currentMonth };
      }

      const validDates = transactions
        .map(t => new Date(t.date + 'T00:00:00'))
        .filter(d => !isNaN(d.getTime()));

      if (validDates.length === 0) {
        return { earliest: currentMonth, latest: currentMonth };
      }

      const min = new Date(Math.min(...validDates));
      const max = new Date(Math.max(...validDates));
      const latestMonth = new Date(max.getFullYear(), max.getMonth(), 1);

      return {
        earliest: new Date(min.getFullYear(), min.getMonth(), 1),
        latest: latestMonth >= currentMonth ? latestMonth : currentMonth
      };
    }

    function computeDateRange(preset, customFrom, customTo) {
      const { earliest, latest } = getDataDateRange();
      let from, to;

      if (preset === 'custom' && customFrom && customTo) {
        from = new Date(customFrom + '-01');
        to = new Date(customTo + '-01');
      } else if (preset === 'all') {
        from = earliest;
        to = latest;
      } else if (preset === 'ytd') {
        from = new Date(latest.getFullYear(), 0, 1);
        to = latest;
      } else {
        const monthCount = parseInt(preset);
        to = latest;
        from = new Date(to.getFullYear(), to.getMonth() - (monthCount - 1), 1);
      }

      MONTHS = generateMonthRange(from, to);
      rangeMonthCount = MONTHS.length;
      updatePeriodLabel();
    }

    function applyDateRange(preset, customFrom, customTo) {
      activePreset = preset;
      computeDateRange(preset, customFrom, customTo);
      renderAll();
    }

    function updatePeriodLabel() {
      if (MONTHS.length === 0) return;
      const first = MONTHS[0];
      const last = MONTHS[MONTHS.length - 1];
      document.getElementById('period-range-text').textContent = `${first} — ${last}`;
      document.getElementById('period-month-count').textContent = `${rangeMonthCount} month${rangeMonthCount !== 1 ? 's' : ''} tracked`;
    }

    function getFilteredTransactions() {
      return transactions.filter(t => MONTHS.includes(t.month));
    }

    const DEFAULT_CATEGORIES = {
      'Core Household': ['Mortgage','Utilities','Trash/Recycle','Internet','Landscaping','Home Alarm/Security','House Cleaning/Assistance','Car Payment (Toyota)','Travel Insurance'],
      'Kids': ['School Tuition','School Lunch','School Fees & Supplies','Kids - Therapy','Extracurricular Activities/Entertainment','Childcare/Babysitting','Kids Clothing','Kids Medical'],
      'Food': ['Groceries','Dining Out','Food Delivery'],
      'Transportation': ['Rideshare'],
      'Health & Wellness': ['Gym','Supplements','Medical Co-Pays/Prescriptions','Health - Therapy','Personal Care/Grooming'],
      'Legal': ['Attorney Fees','Taxes'],
      'Pets': ['Pets (Veterinary)'],
      'Lifestyle': ['Clothing & Apparel','Entertainment','Travel'],
      'Miscellaneous': ['Miscellaneous'],
    };

    let CATEGORIES = JSON.parse(localStorage.getItem('bb_categories') || 'null') || JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));

    const DEFAULT_GROUP_COLORS = {
      'Core Household': '#0ea5e9',
      'Kids': '#ec4899',
      'Food': '#eab308',
      'Transportation': '#8b5cf6',
      'Health & Wellness': '#10b981',
      'Legal': '#ef4444',
      'Pets': '#a78bfa',
      'Lifestyle': '#f97316',
      'Miscellaneous': '#6b7280',
    };
    let GROUP_COLORS = JSON.parse(localStorage.getItem('bb_group_colors') || 'null') || { ...DEFAULT_GROUP_COLORS };

    let FLAT_CATEGORIES = [];
    function rebuildFlatCategories() {
      FLAT_CATEGORIES = [];
      Object.entries(CATEGORIES).forEach(([group, subs]) => subs.forEach(s => FLAT_CATEGORIES.push({ name: s, group })));
    }
    rebuildFlatCategories();

    function saveCategories() {
      localStorage.setItem('bb_categories', JSON.stringify(CATEGORIES));
      localStorage.setItem('bb_group_colors', JSON.stringify(GROUP_COLORS));
      rebuildFlatCategories();
      refreshDropdowns();
      syncToSheet('saveCategories', { categories: CATEGORIES, groupColors: GROUP_COLORS });
    }

    const VENDOR_MAP = {
      'PENTAGON FEDERAL':'Mortgage','PG&E':'Utilities','SF WATER':'Utilities','RECOLOGY':'Trash/Recycle',
      'COMCAST':'Internet','JML LANDSCAPES':'Landscaping','VIVINT':'Home Alarm/Security',
      'AGUIRRE GLORIA':'House Cleaning/Assistance','CHUBB':'Travel Insurance',
      'TARRAH WAUSON':'Kids - Therapy','MANFREDI':'Kids - Therapy','SF MIND MATTERS':'Kids - Therapy',
      'FABIOLA SEGURA':'School Lunch','STJOHNSCHOO':'School Lunch','ST JOHN SCHOOL':'School Fees & Supplies',
      'PLAYSTATION':'Extracurricular Activities/Entertainment','PRIME VIDEO':'Extracurricular Activities/Entertainment',
      'DAVE & BUSTERS':'Extracurricular Activities/Entertainment','CINEMARK':'Extracurricular Activities/Entertainment',
      'GAMESTOP':'Extracurricular Activities/Entertainment','SARA SEGOVIA':'Childcare/Babysitting',
      'SAFEWAY':'Groceries','COSTCO':'Groceries','INSTACART':'Groceries',
      'CUPPA':'Dining Out','CHICK-FIL-A':'Dining Out','DOORDASH':'Food Delivery',
      'UBER':'Rideshare','WAYMO':'Rideshare','MX3FITNESS':'Gym',
      'ONE DENTAL':'Medical Co-Pays/Prescriptions','KAISER':'Medical Co-Pays/Prescriptions',
      'DR. SARAH BRANDELL':'Health - Therapy','SEVEN HILLS':'Pets (Veterinary)',
      'TOTAL WINE':'Entertainment','HIPCAMP':'Travel',
      'CA FRANCHISE TAX':'Taxes','LAW OFFICES':'Attorney Fees',
    };

    // ── STATE ──
    let transactions = JSON.parse(localStorage.getItem('bb_transactions') || '[]').map(t => {
      // Normalize any corrupted data from previous pulls
      if (t.date && !/^\d{4}-\d{2}-\d{2}$/.test(t.date)) {
        const d = new Date(t.date);
        if (!isNaN(d.getTime())) t.date = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
      }
      t.amount = Number(t.amount) || 0;
      t.month = getMonth(t.date);
      return t;
    });


    function save() { localStorage.setItem('bb_transactions', JSON.stringify(transactions)); }

    function getMonth(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()] + ' ' + d.getFullYear();
    }

    function getGroup(category) {
      const found = FLAT_CATEGORIES.find(c => c.name === category);
      return found ? found.group : 'Miscellaneous';
    }

    function fmt(n) { return '$' + Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    // ── SIDEBAR TOGGLE ──
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('active');
    }

    // ── NAVIGATION ──
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        const page = item.dataset.page;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + page).classList.add('active');
        // Close sidebar on mobile
        const sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('open')) toggleSidebar();
        renderAll();
      });
    });

    // ── MODAL ──
    function openModal() {
      document.getElementById('f-edit-id').value = '';
      document.getElementById('txn-modal-title').textContent = 'Add Transaction';
      document.getElementById('txn-submit-btn').textContent = 'Add Transaction';
      document.getElementById('f-status').value = 'approved';
      document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
      document.getElementById('txn-form').reset();
      document.getElementById('f-edit-id').value = '';
    }

    function openEditModal(id) {
      const txn = transactions.find(t => t.id === id);
      if (!txn) return;
      document.getElementById('f-edit-id').value = id;
      document.getElementById('txn-modal-title').textContent = 'Edit Transaction';
      document.getElementById('txn-submit-btn').textContent = 'Save Changes';
      document.getElementById('f-date').value = txn.date;
      document.getElementById('f-card').value = txn.card;
      document.getElementById('f-vendor').value = txn.vendor;
      document.getElementById('f-amount').value = txn.amount;
      document.getElementById('f-category').value = txn.category;
      document.getElementById('f-notes').value = txn.notes || '';
      // Set status
      if (txn.declined) {
        document.getElementById('f-status').value = 'declined';
      } else if (txn.needsReview) {
        document.getElementById('f-status').value = 'review';
      } else {
        document.getElementById('f-status').value = 'approved';
      }
      document.getElementById('modal-overlay').classList.add('active');
    }

    // ── SAVE TRANSACTION (ADD / EDIT) ──
    function saveTransaction(e) {
      e.preventDefault();
      const editId = document.getElementById('f-edit-id').value;
      const status = document.getElementById('f-status').value;
      const data = {
        date: document.getElementById('f-date').value,
        card: document.getElementById('f-card').value,
        vendor: document.getElementById('f-vendor').value,
        amount: parseFloat(document.getElementById('f-amount').value),
        category: document.getElementById('f-category').value,
        notes: document.getElementById('f-notes').value,
        needsReview: status === 'review',
        declined: status === 'declined',
        month: getMonth(document.getElementById('f-date').value),
      };

      if (editId) {
        const txn = transactions.find(t => t.id === editId);
        if (txn) {
          if (txn.declined && !data.declined && data.notes) {
            data.notes = data.notes.replace(/\s*\|\s*DECLINED$/,'').replace(/^DECLINED\s*\|\s*/,'').replace(/^DECLINED$/,'');
          }
          Object.assign(txn, data);
          syncToSheet('updateTransaction', { data: txn });
        }
      } else {
        data.id = Date.now().toString();
        transactions.push(data);
        syncToSheet('addTransaction', { data });
      }
      save();
      closeModal();
      renderAll();
    }

    function deleteTransaction(id) {
      if (!confirm('Delete this transaction?')) return;
      transactions = transactions.filter(t => t.id !== id);
      save();
      renderAll();
      syncToSheet('deleteTransaction', { id });
    }

    function declineTransaction(id) {
      const txn = transactions.find(t => t.id === id);
      if (!txn) return;
      if (!confirm(`Decline "${txn.vendor}" — $${txn.amount.toFixed(2)}?`)) return;
      txn.needsReview = false;
      txn.declined = true;
      txn.notes = (txn.notes ? txn.notes + ' | ' : '') + 'DECLINED';
      save();
      renderAll();
      syncToSheet('updateTransaction', { data: txn });
    }

    // ── CATEGORY MANAGEMENT ──
    function openCatModal(mode = 'add', groupName = '', catName = '') {
      document.getElementById('cf-mode').value = mode;
      document.getElementById('cf-old-name').value = catName;
      document.getElementById('cf-old-group').value = groupName;
      document.getElementById('cat-modal-title').textContent = mode === 'edit' ? 'Edit Category' : 'Add Category';

      const groupSelect = document.getElementById('cf-group');
      groupSelect.innerHTML = '';
      Object.keys(CATEGORIES).forEach(g => {
        const o = document.createElement('option');
        o.value = g; o.textContent = g;
        if (g === groupName) o.selected = true;
        groupSelect.appendChild(o);
      });

      document.getElementById('cf-name').value = catName;
      document.getElementById('cat-modal-overlay').classList.add('active');
    }

    function closeCatModal() {
      document.getElementById('cat-modal-overlay').classList.remove('active');
      document.getElementById('cat-form').reset();
    }

    function saveCategoryForm(e) {
      e.preventDefault();
      const mode = document.getElementById('cf-mode').value;
      const group = document.getElementById('cf-group').value;
      const name = document.getElementById('cf-name').value.trim();
      const oldName = document.getElementById('cf-old-name').value;
      const oldGroup = document.getElementById('cf-old-group').value;

      if (!name) return false;

      if (mode === 'add') {
        if (CATEGORIES[group].includes(name)) {
          alert('This category already exists in ' + group);
          return false;
        }
        CATEGORIES[group].push(name);
      } else if (mode === 'edit') {
        // Remove from old group
        CATEGORIES[oldGroup] = CATEGORIES[oldGroup].filter(c => c !== oldName);
        // Add to (possibly new) group
        CATEGORIES[group].push(name);
        // Update transactions that used the old name
        transactions.forEach(t => { if (t.category === oldName) t.category = name; });
        save();
      }

      saveCategories();
      closeCatModal();
      renderAll();
      return false;
    }

    function deleteCategory(group, catName) {
      const txnCount = transactions.filter(t => t.category === catName).length;
      const msg = txnCount > 0
        ? `Delete "${catName}"? ${txnCount} transaction(s) use this category and will be moved to "Miscellaneous".`
        : `Delete "${catName}" from ${group}?`;
      if (!confirm(msg)) return;

      CATEGORIES[group] = CATEGORIES[group].filter(c => c !== catName);
      if (txnCount > 0) {
        transactions.forEach(t => { if (t.category === catName) t.category = 'Miscellaneous'; });
        save();
      }
      saveCategories();
      renderAll();
    }

    function openGroupModal() {
      document.getElementById('group-modal-overlay').classList.add('active');
    }

    function closeGroupModal() {
      document.getElementById('group-modal-overlay').classList.remove('active');
      document.getElementById('group-form').reset();
    }

    function saveGroupForm(e) {
      e.preventDefault();
      const name = document.getElementById('gf-name').value.trim();
      const color = document.getElementById('gf-color').value;
      if (!name) return false;
      if (CATEGORIES[name]) { alert('Group already exists!'); return false; }
      CATEGORIES[name] = [];
      GROUP_COLORS[name] = color;
      saveCategories();
      closeGroupModal();
      renderAll();
      return false;
    }

    function deleteGroup(groupName) {
      const subs = CATEGORIES[groupName] || [];
      const txnCount = transactions.filter(t => subs.includes(t.category)).length;
      const msg = txnCount > 0
        ? `Delete group "${groupName}" and its ${subs.length} categories? ${txnCount} transaction(s) will be moved to "Miscellaneous".`
        : `Delete group "${groupName}" and its ${subs.length} categories?`;
      if (!confirm(msg)) return;

      if (txnCount > 0) {
        transactions.forEach(t => { if (subs.includes(t.category)) t.category = 'Miscellaneous'; });
        save();
      }
      delete CATEGORIES[groupName];
      delete GROUP_COLORS[groupName];
      saveCategories();
      renderAll();
    }

    // ── REVIEW APPROVAL ──
    let approvalTxnId = null;

    function openApproveModal(txnId) {
      const txn = transactions.find(t => t.id === txnId);
      if (!txn) return;
      approvalTxnId = txnId;

      document.getElementById('approve-info').innerHTML =
        `<strong>${txn.vendor}</strong> &mdash; ${fmt(txn.amount)}<br>
         <span style="font-size:12px;color:var(--text-muted);">${new Date(txn.date + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} &bull; ${txn.card}</span>`;

      // Populate category dropdown
      const catSelect = document.getElementById('approve-category');
      catSelect.innerHTML = '';
      Object.entries(CATEGORIES).forEach(([group, subs]) => {
        const og = document.createElement('optgroup');
        og.label = group;
        subs.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; og.appendChild(o); });
        catSelect.appendChild(og);
      });
      catSelect.value = txn.category;

      document.getElementById('approve-notes').value = txn.notes || '';
      document.getElementById('approve-txn-id').value = txnId;
      document.getElementById('approve-modal-overlay').classList.add('active');
    }

    function closeApproveModal() {
      document.getElementById('approve-modal-overlay').classList.remove('active');
      approvalTxnId = null;
    }

    function confirmApproval() {
      const txnId = document.getElementById('approve-txn-id').value;
      const txn = transactions.find(t => t.id === txnId);
      if (!txn) return;

      txn.category = document.getElementById('approve-category').value;
      txn.notes = document.getElementById('approve-notes').value;
      txn.needsReview = false;
      txn.declined = false;
      save();
      closeApproveModal();
      renderAll();
      syncToSheet('updateTransaction', { data: txn });
    }

    // ── EXPORT CSV ──
    function exportCSV() {
      const cardF = document.getElementById('filter-card').value;
      const catF = document.getElementById('filter-category').value;
      const monthF = document.getElementById('filter-month').value;
      const reviewF = document.getElementById('filter-review').value;

      let data = [...getFilteredTransactions()];
      if (cardF) data = data.filter(t => t.card === cardF);
      if (catF) data = data.filter(t => t.category === catF);
      if (monthF) data = data.filter(t => t.month === monthF);
      if (reviewF === 'yes') data = data.filter(t => t.needsReview && !t.declined);
      if (reviewF === 'no') data = data.filter(t => !t.needsReview && !t.declined);
      if (reviewF === 'declined') data = data.filter(t => t.declined);
      data.sort((a, b) => a.date.localeCompare(b.date));

      const headers = ['Date', 'Card / Account', 'Vendor', 'Amount', 'Main Group', 'Category', 'Notes', 'Status', 'Month'];
      const rows = data.map(t => [
        t.date,
        t.card,
        `"${t.vendor.replace(/"/g, '""')}"`,
        t.amount.toFixed(2),
        getGroup(t.category),
        `"${t.category.replace(/"/g, '""')}"`,
        `"${(t.notes || '').replace(/"/g, '""')}"`,
        t.declined ? 'Declined' : t.needsReview ? 'Needs Review' : 'Approved',
        t.month,
      ]);

      const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const rangeLabel = MONTHS.length > 0 ? `${MONTHS[0]}-${MONTHS[MONTHS.length-1]}` : 'all';
      a.href = url;
      a.download = `BudgetBloom_${rangeLabel.replace(/ /g, '')}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ── AUTO-CATEGORIZE ──
    function autoCategory(vendor) {
      const v = vendor.toUpperCase();
      for (const [key, cat] of Object.entries(VENDOR_MAP)) {
        if (v.includes(key.toUpperCase())) return cat;
      }
      return '';
    }

    // ── RENDER ──
    function renderAll() {
      // Recompute MONTHS from current transaction data so new months are included
      computeDateRange(activePreset);
      refreshDropdowns();
      renderStats();
      renderRecentTable();
      renderTransactions();
      renderCategories();
      renderCards();
      renderTherapy();
      renderCharts();
      updateSyncUI();
    }

    function renderStats() {
      const filtered = getFilteredTransactions();
      const total = filtered.reduce((s, t) => s + t.amount, 0);
      const avg = rangeMonthCount > 0 ? total / rangeMonthCount : 0;
      const reviewCount = filtered.filter(t => t.needsReview).length;
      const txnCount = filtered.length;
      const rangeLabel = MONTHS.length > 0 ? `${MONTHS[0]} — ${MONTHS[MONTHS.length - 1]}` : '—';

      document.getElementById('stats-grid').innerHTML = `
        <div class="stat-card pink animate-in">
          <div class="label">Total Spending</div>
          <div class="value">${fmt(total)}</div>
          <div class="sub">${rangeLabel}</div>
        </div>
        <div class="stat-card mint animate-in" style="animation-delay:0.1s">
          <div class="label">Monthly Average</div>
          <div class="value">${fmt(avg)}</div>
          <div class="sub">Across ${rangeMonthCount} month${rangeMonthCount !== 1 ? 's' : ''}</div>
        </div>
        <div class="stat-card lavender animate-in" style="animation-delay:0.2s">
          <div class="label">Transactions</div>
          <div class="value">${txnCount}</div>
          <div class="sub">${reviewCount} need review</div>
        </div>
        <div class="stat-card peach animate-in" style="animation-delay:0.3s">
          <div class="label">Credit Cards</div>
          <div class="value">6</div>
          <div class="sub">+ recurring charges</div>
        </div>
      `;
    }

    function renderRecentTable() {
      const sorted = [...transactions].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 8);
      const tbody = document.getElementById('recent-table');
      tbody.innerHTML = sorted.map(t => {
        let statusHtml = '';
        if (t.declined) {
          statusHtml = '<span class="status-declined">✕ Declined</span>';
        } else if (t.needsReview) {
          statusHtml = `<span class="review-flag">⚠ Review</span> <button class="btn-approve" onclick="openApproveModal('${t.id}')">Approve</button> <button class="btn-decline" onclick="declineTransaction('${t.id}')">Decline</button>`;
        } else {
          statusHtml = '<span style="color:var(--mint);font-size:12px;font-weight:600;">✓ Done</span>';
        }
        return `<tr style="${t.declined ? 'background:var(--coral-light);opacity:0.7;' : t.needsReview ? 'background:var(--yellow-light);' : ''}">
          <td>${new Date(t.date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
          <td>${t.card}</td>
          <td>${t.vendor}</td>
          <td class="amount negative">${fmt(t.amount)}</td>
          <td><span class="category-pill" style="background:${GROUP_COLORS[getGroup(t.category)] || '#eee'}30; color:${GROUP_COLORS[getGroup(t.category)] || '#999'}">${t.category}</span></td>
          <td>${statusHtml}</td>
        </tr>`;
      }).join('');
    }

    function renderTransactions() {
      const cardF = document.getElementById('filter-card').value;
      const catF = document.getElementById('filter-category').value;
      const monthF = document.getElementById('filter-month').value;
      const reviewF = document.getElementById('filter-review').value;

      let filtered = [...transactions];
      if (cardF) filtered = filtered.filter(t => t.card === cardF);
      if (catF) filtered = filtered.filter(t => t.category === catF);
      if (monthF) filtered = filtered.filter(t => t.month === monthF);
      if (reviewF === 'yes') filtered = filtered.filter(t => t.needsReview && !t.declined);
      if (reviewF === 'no') filtered = filtered.filter(t => !t.needsReview && !t.declined);
      if (reviewF === 'declined') filtered = filtered.filter(t => t.declined);

      filtered.sort((a, b) => b.date.localeCompare(a.date));

      const tbody = document.getElementById('txn-table');
      const empty = document.getElementById('txn-empty');

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      tbody.innerHTML = filtered.map(t => {
        const isRecurring = t.id.startsWith('r-');
        let statusHtml = '';
        if (t.declined) {
          statusHtml = '<span class="status-declined">✕ Declined</span>';
        } else if (t.needsReview) {
          statusHtml = `<span class="review-flag">⚠ Review</span>
            <button class="btn-approve" onclick="openApproveModal('${t.id}')">Approve</button>
            <button class="btn-decline" onclick="declineTransaction('${t.id}')">Decline</button>`;
        } else {
          statusHtml = '<span style="color:var(--mint);font-size:12px;font-weight:600;">✓ Approved</span>';
        }

        let actionsHtml = '';
        if (!isRecurring) {
          actionsHtml = `<div class="txn-actions">
            <button class="btn-icon" onclick="openEditModal('${t.id}')" title="Edit">✎</button>
            <button class="btn-icon danger" onclick="deleteTransaction('${t.id}')" title="Delete">✕</button>
          </div>`;
        }

        return `<tr style="${t.declined ? 'background:var(--coral-light);opacity:0.7;' : t.needsReview ? 'background:var(--yellow-light);' : ''}">
          <td>${new Date(t.date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
          <td style="font-size:12px;">${t.card}</td>
          <td>${t.vendor}</td>
          <td class="amount negative">${fmt(t.amount)}</td>
          <td><span class="category-pill" style="background:${GROUP_COLORS[getGroup(t.category)] || '#eee'}30; color:${GROUP_COLORS[getGroup(t.category)] || '#999'}">${t.category}</span></td>
          <td style="font-size:12px; color:var(--text-muted); max-width:180px;">${t.notes || '—'}</td>
          <td>${statusHtml}</td>
          <td>${actionsHtml}</td>
        </tr>`;
      }).join('');
    }

    function renderCategories() {
      const container = document.getElementById('categories-breakdown');
      const fTxns = getFilteredTransactions();
      const maxAmount = Math.max(...Object.keys(CATEGORIES).map(group =>
        CATEGORIES[group].reduce((s, cat) => s + fTxns.filter(t => t.category === cat).reduce((ss, t) => ss + t.amount, 0), 0)
      ), 1);

      let html = '';
      Object.entries(CATEGORIES).forEach(([group, subs]) => {
        const groupTotal = subs.reduce((s, cat) => s + fTxns.filter(t => t.category === cat).reduce((ss, t) => ss + t.amount, 0), 0);
        const isProtected = group === 'Miscellaneous';
        html += `<div style="margin-bottom:20px;">`;
        html += `<div class="group-header-bar" style="background:${GROUP_COLORS[group]}20;">`;
        html += `<div style="display:flex;align-items:center;gap:8px;">`;
        html += `<span style="font-weight:700;font-size:14px;">${group}</span>`;
        html += `<button class="btn-icon" onclick="openCatModal('add','${group.replace(/'/g, "\\'")}')" title="Add category to ${group}">+</button>`;
        html += `</div>`;
        html += `<div style="display:flex;align-items:center;gap:8px;">`;
        html += `<span style="font-family:'Inter';font-weight:800;font-size:15px;">${fmt(groupTotal)}</span>`;
        if (!isProtected) html += `<button class="btn-icon danger" onclick="deleteGroup('${group.replace(/'/g, "\\'")}')" title="Delete group">🗑</button>`;
        html += `</div>`;
        html += `</div>`;

        subs.forEach(cat => {
          const catTotal = fTxns.filter(t => t.category === cat).reduce((s, t) => s + t.amount, 0);
          const pct = maxAmount > 0 ? (catTotal / maxAmount * 100) : 0;
          const escapedCat = cat.replace(/'/g, "\\'");
          const escapedGroup = group.replace(/'/g, "\\'");
          html += `<div class="category-row">
            <span class="category-name">${cat}</span>
            <div class="category-bar-wrap"><div class="category-bar" style="width:${pct}%;background:${GROUP_COLORS[group]};"></div></div>
            <span class="category-amount">${fmt(catTotal)}</span>
            <span class="category-avg">${fmt(catTotal / rangeMonthCount)}/mo</span>
            <div class="cat-sub-actions">
              <button class="btn-icon" onclick="openCatModal('edit','${escapedGroup}','${escapedCat}')" title="Edit">✏️</button>
              <button class="btn-icon danger" onclick="deleteCategory('${escapedGroup}','${escapedCat}')" title="Delete">✕</button>
            </div>
          </div>`;
        });
        html += `</div>`;
      });

      container.innerHTML = html;
    }

    function renderCards() {
      const container = document.getElementById('cards-list');
      const allCards = [...CREDIT_CARDS, 'N/A (Recurring)'];
      const cardIcons = { 'Apple': '🍎', 'Capital One Silver': '🥈', 'Capital One Blue': '🔵', 'Concora': '🟡', 'Brightway': '☀️', 'Wells Fargo': '🏦', 'N/A (Recurring)': '🔄' };
      const cardColors = { 'Apple': 'var(--peach-light)', 'Capital One Silver': 'var(--sky-light)', 'Capital One Blue': 'var(--lavender-light)', 'Concora': 'var(--yellow-light)', 'Brightway': 'var(--mint-light)', 'Wells Fargo': 'var(--coral-light)', 'N/A (Recurring)': 'var(--bg)' };
      const total = transactions.reduce((s, t) => s + t.amount, 0);

      let html = '<div class="card-header"><span class="card-title">Spending by Card</span></div>';
      allCards.forEach(card => {
        const cardTotal = transactions.filter(t => t.card === card).reduce((s, t) => s + t.amount, 0);
        if (cardTotal === 0) return;
        const pct = total > 0 ? ((cardTotal / total) * 100).toFixed(1) : 0;
        html += `<div class="cc-card" style="background:${cardColors[card] || 'var(--bg)'}">
          <div class="cc-icon" style="background:white;font-size:22px;">${cardIcons[card] || '💳'}</div>
          <div class="cc-info">
            <div class="cc-name">${card}</div>
            <div class="cc-pct">${pct}% of total</div>
          </div>
          <div class="cc-amount">${fmt(cardTotal)}</div>
        </div>`;
      });
      container.innerHTML = html;
    }

    function renderTherapy() {
      const fTxns = getFilteredTransactions();
      const kidsTherapy = fTxns.filter(t => t.category === 'Kids - Therapy');
      const healthTherapy = fTxns.filter(t => t.category === 'Health - Therapy');
      const kidsTotal = kidsTherapy.reduce((s, t) => s + t.amount, 0);
      const healthTotal = healthTherapy.reduce((s, t) => s + t.amount, 0);
      const allTotal = kidsTotal + healthTotal;
      const mc = rangeMonthCount || 1;

      document.getElementById('therapy-summary').innerHTML = `
        <h3>Therapy Expense Summary</h3>
        <div class="therapy-grid">
          <div class="therapy-item">
            <div class="t-label">Kids Therapy</div>
            <div class="t-value">${fmt(kidsTotal)}</div>
            <div class="t-avg">${fmt(kidsTotal / mc)}/mo avg</div>
          </div>
          <div class="therapy-item">
            <div class="t-label">Health Therapy</div>
            <div class="t-value">${fmt(healthTotal)}</div>
            <div class="t-avg">${fmt(healthTotal / mc)}/mo avg</div>
          </div>
          <div class="therapy-item">
            <div class="t-label">Total Therapy</div>
            <div class="t-value" style="color:var(--accent-hover);">${fmt(allTotal)}</div>
            <div class="t-avg">${fmt(allTotal / mc)}/mo avg</div>
          </div>
        </div>
      `;

      const allTherapy = [...kidsTherapy, ...healthTherapy].sort((a, b) => b.date.localeCompare(a.date));
      document.getElementById('therapy-table').innerHTML = allTherapy.map(t => `
        <tr>
          <td>${new Date(t.date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
          <td>${t.card}</td>
          <td>${t.vendor}</td>
          <td class="amount negative">${fmt(t.amount)}</td>
          <td><span class="category-pill" style="background:${t.category.includes('Kids') ? 'var(--accent-light)' : 'var(--mint-light)'}; color:${t.category.includes('Kids') ? 'var(--accent-hover)' : '#5bb88a'}">${t.category}</span></td>
        </tr>
      `).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:32px;">No therapy transactions recorded yet</td></tr>';
    }

    // ── CHARTS ──
    let monthlyChart, categoryPieChart, cardsPieChart;

    function renderCharts() {
      // Monthly chart
      const fTxns = getFilteredTransactions();
      const monthlyData = MONTHS.map(m => fTxns.filter(t => t.month === m).reduce((s, t) => s + t.amount, 0));

      if (monthlyChart) monthlyChart.destroy();
      monthlyChart = new Chart(document.getElementById('monthlyChart'), {
        type: 'bar',
        data: {
          labels: MONTHS,
          datasets: [{
            data: monthlyData,
            backgroundColor: 'rgba(99,102,241,0.15)',
            borderColor: '#6366f1',
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' }, grid: { color: 'rgba(15,23,42,0.04)' } },
            x: { grid: { display: false } },
          }
        }
      });

      // Category pie
      const groupTotals = Object.keys(CATEGORIES).map(g =>
        CATEGORIES[g].reduce((s, c) => s + fTxns.filter(t => t.category === c).reduce((ss, t) => ss + t.amount, 0), 0)
      ).filter(v => v > 0);
      const groupLabels = Object.keys(CATEGORIES).filter((g, i) => {
        const total = CATEGORIES[g].reduce((s, c) => s + fTxns.filter(t => t.category === c).reduce((ss, t) => ss + t.amount, 0), 0);
        return total > 0;
      });

      if (categoryPieChart) categoryPieChart.destroy();
      categoryPieChart = new Chart(document.getElementById('categoryPieChart'), {
        type: 'doughnut',
        data: {
          labels: groupLabels,
          datasets: [{ data: groupTotals, backgroundColor: groupLabels.map(g => GROUP_COLORS[g]), borderWidth: 0 }]
        },
        options: { responsive: true, plugins: { legend: { position: 'right', labels: { font: { size: 11, family: 'DM Sans' }, boxWidth: 12, padding: 8 } } }, cutout: '65%' }
      });

      // Cards pie (uses all transactions, not period-filtered)
      const cardTotals = CREDIT_CARDS.map(c => transactions.filter(t => t.card === c).reduce((s, t) => s + t.amount, 0)).filter(v => v > 0);
      const cardLabels = CREDIT_CARDS.filter((c, i) => transactions.filter(t => t.card === c).reduce((s, t) => s + t.amount, 0) > 0);
      const cardColors = ['#f5c6a5', '#a8d4e6', '#c7b8ea', '#f0df8a', '#b8e6d0', '#f0a8a8'];

      if (cardsPieChart) cardsPieChart.destroy();
      cardsPieChart = new Chart(document.getElementById('cardsPieChart'), {
        type: 'doughnut',
        data: {
          labels: cardLabels,
          datasets: [{ data: cardTotals, backgroundColor: cardColors.slice(0, cardLabels.length), borderWidth: 0 }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { font: { size: 11, family: 'DM Sans' }, boxWidth: 12, padding: 8 } } }, cutout: '60%' }
      });
    }

    // ── POPULATE DROPDOWNS ──
    function populateDropdowns() {
      // Form dropdowns
      const cardSelect = document.getElementById('f-card');
      cardSelect.innerHTML = '';
      CREDIT_CARDS.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; cardSelect.appendChild(o); });

      populateCategorySelect(document.getElementById('f-category'));

      // Filter dropdowns
      const filterCard = document.getElementById('filter-card');
      filterCard.innerHTML = '<option value="">All Cards</option>';
      CREDIT_CARDS.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; filterCard.appendChild(o); });
      const ro = document.createElement('option'); ro.value = 'N/A (Recurring)'; ro.textContent = 'Recurring'; filterCard.appendChild(ro);

      const filterCat = document.getElementById('filter-category');
      filterCat.innerHTML = '<option value="">All Categories</option>';
      Object.entries(CATEGORIES).forEach(([group, subs]) => {
        const og = document.createElement('optgroup');
        og.label = group;
        subs.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; og.appendChild(o); });
        filterCat.appendChild(og);
      });

      const filterMonth = document.getElementById('filter-month');
      filterMonth.innerHTML = '<option value="">All Months</option>';
      MONTHS.forEach(m => { const o = document.createElement('option'); o.value = m; o.textContent = m; filterMonth.appendChild(o); });
    }

    function populateCategorySelect(select) {
      select.innerHTML = '';
      Object.entries(CATEGORIES).forEach(([group, subs]) => {
        const og = document.createElement('optgroup');
        og.label = group;
        subs.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; og.appendChild(o); });
        select.appendChild(og);
      });
    }

    function refreshDropdowns() {
      populateCategorySelect(document.getElementById('f-category'));
      const filterCat = document.getElementById('filter-category');
      const currentVal = filterCat.value;
      filterCat.innerHTML = '<option value="">All Categories</option>';
      Object.entries(CATEGORIES).forEach(([group, subs]) => {
        const og = document.createElement('optgroup');
        og.label = group;
        subs.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; og.appendChild(o); });
        filterCat.appendChild(og);
      });
      filterCat.value = currentVal;

      // Refresh month filter
      const filterMonth = document.getElementById('filter-month');
      const currentMonth = filterMonth.value;
      filterMonth.innerHTML = '<option value="">All Months</option>';
      MONTHS.forEach(m => { const o = document.createElement('option'); o.value = m; o.textContent = m; filterMonth.appendChild(o); });
      filterMonth.value = currentMonth;
    }

    // ── AUTO-CATEGORY on vendor input ──
    document.getElementById('f-vendor').addEventListener('blur', function() {
      const cat = autoCategory(this.value);
      if (cat) document.getElementById('f-category').value = cat;
    });

    // ── DATE RANGE PICKER ──
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const val = this.dataset.months;

        if (val === 'custom') {
          document.getElementById('custom-range').style.display = 'block';
          return;
        }
        document.getElementById('custom-range').style.display = 'none';
        applyDateRange(val);
      });
    });

    document.getElementById('range-from').addEventListener('change', applyCustomRange);
    document.getElementById('range-to').addEventListener('change', applyCustomRange);

    function applyCustomRange() {
      const from = document.getElementById('range-from').value;
      const to = document.getElementById('range-to').value;
      if (from && to) applyDateRange('custom', from, to);
    }

    // ── GOOGLE SHEETS SYNC ──
    function updateSyncUI() {
      const dot = document.getElementById('sync-dot');
      const label = document.getElementById('sync-label');
      const statusPill = document.getElementById('settings-status');
      const urlInput = document.getElementById('api-url');

      if (API.isConnected) {
        dot.className = 'sync-dot connected';
        label.textContent = 'Google Sheets';
        statusPill.textContent = 'Connected';
        statusPill.style.background = 'var(--mint-light)';
        statusPill.style.color = '#059669';
        urlInput.value = API.url;
      } else {
        dot.className = 'sync-dot disconnected';
        label.textContent = 'Local Storage';
        statusPill.textContent = 'Disconnected';
        statusPill.style.background = 'var(--bg)';
        statusPill.style.color = 'var(--text-muted)';
      }

      // Update local stats
      document.getElementById('local-txn-count').textContent = transactions.length;
      document.getElementById('local-cat-count').textContent = Object.keys(CATEGORIES).length;
    }

    function setSyncing(isSyncing) {
      const dot = document.getElementById('sync-dot');
      const label = document.getElementById('sync-label');
      if (isSyncing) {
        dot.className = 'sync-dot syncing';
        label.textContent = 'Syncing...';
      } else {
        updateSyncUI();
      }
    }

    async function connectAPI() {
      const url = document.getElementById('api-url').value.trim();
      if (!url) return alert('Please enter the Apps Script Web App URL');

      setSyncing(true);
      try {
        const res = await fetch(url + '?action=ping', { redirect: 'follow' });
        const data = await res.json();
        if (data.status === 'ok') {
          API.url = url;
          updateSyncUI();
          alert('Connected successfully! Use "Push" or "Pull" to sync your data.');
        } else {
          throw new Error('Invalid response');
        }
      } catch (err) {
        alert('Connection failed. Check the URL and make sure the web app is deployed as "Anyone".');
        setSyncing(false);
      }
    }

    function disconnectAPI() {
      if (!confirm('Disconnect from Google Sheets? Local data will be kept.')) return;
      localStorage.setItem('bb_api_url', '');
      document.getElementById('api-url').value = '';
      updateSyncUI();
    }

    async function pushToSheet() {
      if (!API.isConnected) return alert('Connect to Google Sheets first');
      if (!confirm(`Push ${transactions.length} transactions to Google Sheets? This will overwrite the sheet.`)) return;

      setSyncing(true);
      const result = await API.post({
        action: 'syncAll',
        transactions,
        categories: CATEGORIES,
        groupColors: GROUP_COLORS,
      });
      setSyncing(false);

      if (result && result.success) {
        alert('Synced ' + result.count + ' transactions to Google Sheets');
      } else {
        alert('Sync failed: ' + (result ? result.error : 'Network error'));
      }
    }

    function normalizeTransaction(t) {
      t.id = String(t.id || Date.now());
      // Fix date format — ensure YYYY-MM-DD
      if (t.date && !/^\d{4}-\d{2}-\d{2}$/.test(t.date)) {
        const d = new Date(t.date);
        if (!isNaN(d.getTime())) {
          t.date = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }
      }
      t.amount = Number(t.amount) || 0;
      t.needsReview = (t.needsReview === true || t.needsReview === 'true' || t.needsReview === 'TRUE');
      t.declined = (t.declined === true || t.declined === 'true' || t.declined === 'TRUE');
      // Recalculate month from date to ensure consistency
      t.month = getMonth(t.date);
      t.card = t.card || '';
      t.vendor = t.vendor || '';
      t.category = t.category || 'Miscellaneous';
      t.notes = t.notes || '';
      return t;
    }

    async function pullFromSheet() {
      if (!API.isConnected) return alert('Connect to Google Sheets first');
      if (!confirm('Download data from Google Sheets? This will replace your local data.')) return;

      setSyncing(true);
      const result = await API.get('loadAll');
      setSyncing(false);

      if (result && result.success) {
        transactions = (result.transactions || []).map(normalizeTransaction);
        if (result.categories) CATEGORIES = result.categories;
        if (result.groupColors) GROUP_COLORS = result.groupColors;
        save();
        saveCategories();
        rebuildFlatCategories();
        renderAll();
        alert('Loaded ' + transactions.length + ' transactions from Google Sheets');
      } else {
        alert('Pull failed: ' + (result ? result.error : 'Network error'));
      }
    }

    // Background sync: after every local save, push to sheet if connected
    async function syncToSheet(action, data) {
      if (!API.isConnected) return;
      setSyncing(true);
      await API.post({ action, ...data });
      setSyncing(false);
    }

    function clearLocalData() {
      if (!confirm('Clear all local data? This cannot be undone. (Google Sheet data is not affected)')) return;
      localStorage.removeItem('bb_transactions');
      localStorage.removeItem('bb_categories');
      localStorage.removeItem('bb_group_colors');
      transactions = [];
      CATEGORIES = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
      GROUP_COLORS = { ...DEFAULT_GROUP_COLORS };
      rebuildFlatCategories();
      refreshDropdowns();
      renderAll();
      updateSyncUI();
    }

    // ── INIT ──
    populateDropdowns();
    applyDateRange('12'); // default 12 months
    updateSyncUI();
  </script>
</body>
</html>
